(function(){tinymce.create("org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatmatheditor",{init:function(c,e){var g;function d(){if(g){return g}var i=o_getMainWin();if(i){g=jQuery(document).ooTranslator().getTranslator(i.o_info.locale,"org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatmatheditor")}else{g={translate:function(j){return j}}}return g}function f(){var j=win.find("#latex")[0].value();var i=c.selection.getNode();if((i!=null)&&(/mceItemJSMath/.test(c.dom.getAttrib(i,"class")))){c.dom.setAttrib(i,"title",j);c.dom.setAttrib(i,"alt",escape(j));c.execCommand("mceRepaint")}else{var k='<img src="'+c.getParam("olatsmileys_transparentImage")+'" class="mceItemJSMath" title="'+j+'" alt="'+escape(j)+'" width="32" height="32"/>';c.execCommand("mceInsertContent",false,k)}}function h(){var i=jQuery("#mathpreviewOffscreen");var j=win.find("#latex")[0].value();i.text(j);i.addClass("math");BFormatter.formatLatexFormulas("mathpreviewOffscreen");setTimeout(function(){jsMath.Synchronize(b)},100)}function b(){var j=jQuery("#mathpreviewOffscreen");var k=jQuery("#mathpreviewOffscreen *:first-child");var l=jQuery("#mathpreviewFormula");var i=jQuery("#mathpreviewErrorMessage");if(k.length>0){if(k.get(0).nodeName=="NOBR"){l.html(j.html());i.html("")}else{if(k.nodeName=="SPAN"){if(k.hasClass("error")){i.html(j.html())}}}}else{l.html(j.html())}}function a(){win=c.windowManager.open({title:d().translate("olatmatheditor.formulaTabTitle"),minWidth:540,body:[{type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,items:[{type:"label",text:d().translate("olatmatheditor.latexGroupTitle")},{name:"latex",type:"textbox",multiline:true,flex:1,minHeight:120,onkeyup:h},{name:"preview",type:"panel",label:"",flex:1,minHeight:120,html:'<div id="mathpreviewFormula" class="math" style="width:100%; height=100%;"></div><div id="mathpreviewErrorMessage" class="math"></div><div id="mathpreviewOffscreen" class="math" style="display:none;"></div>'}]}],onSubmit:f});var j=c.selection.getNode();if((j.nodeName.toLowerCase()=="img")&&(j.className=="mceItemJSMath")){var i=unescape(j.alt);win.find("#latex")[0].value(i);h()}}c.addButton("olatmatheditor",{title:d().translate("olatmatheditor.desc"),image:e+"/img/sigma.png",onclick:a,onPostRender:function(){var i=this;c.on("NodeChange",function(j){var k=(j.element.nodeName=="IMG")&&(/mceItemJSMath/.test(c.dom.getAttrib(j.element,"class")));i.active(k);if(k){j.preventDefault(true);j.stopImmediatePropagation()}})}});c.on("init",function(){if(c.settings.content_css!==false){c.dom.loadCSS(e+"/css/content.css")}});c.on("LoadContent",function(i){tinymce.each(c.dom.select("span.math"),function(k){var l=k.innerHTML;var j=c.dom.create("img",{"class":"mceItemJSMath",width:"32",height:"32",src:c.getParam("olatsmileys_transparentImage"),title:l,alt:k.title});c.dom.replace(j,k)})});c.on("PreProcess",function(i){tinymce.each(c.dom.select("img.mceItemJSMath"),function(k){var j=c.dom.create("span",{"class":"math",title:k.alt},k.title);c.dom.replace(j,k)})})},createControl:function(b,a){return null},getInfo:function(){return{longname:"OpenOLAT Math Editor",author:"frentix GmbH",authorurl:"http://www.frentix.com",infourl:"http://www.frentix.com",version:"1.1"}}});tinymce.PluginManager.add("olatmatheditor",org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatmatheditor)})();