<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
  http://www.springframework.org/schema/beans 
  http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

	<!--
		****************************************************
		*** Configuration for OLAT Cluster/SingleVM Coordinator   ***
		****************************************************
		
	-->

<bean id="org.olat.commons.coordinate.cluster.ClusterConfig" class="org.olat.core.util.cluster.ClusterConfig">
		<!-- nodeId must be a cluster-wide unique integer between 1 and 63 -->
		<property name="nodeId" value="${node.id}" />
</bean>

<bean id="coordinatorManager" class="org.olat.core.util.coordinate.CoordinatorManagerImpl">
		<property name="coordinator" ref="org.olat.core.util.coordinate.${cluster.mode}Coordinator"/>
</bean>


<bean id="org.olat.core.util.coordinate.ClusterCoordinator" 
	class="org.olat.commons.coordinate.cluster.ClusterCoordinator" lazy-init="true">
		<property name="locker" >
			<bean class="org.olat.commons.coordinate.cluster.lock.ClusterLocker" init-method="init">
				<constructor-arg index="0" ref="clusterLockManager" />
				<property name="syncer" ref="org.olat.commons.coordinate.cluster.ClusterSyncer" />
				<property name="eventBus" ref="org.olat.commons.coordinate.cluster.jms.ClusterEventBus" />
				<!-- to avoid circular reference method lookup is used for dependecy injection of persistent lock manager -->
				<lookup-method name="getPersistentLockManager" bean="persistentLockManager"/>
			</bean>
		</property>
		<property name="clusterConfig" ref="org.olat.commons.coordinate.cluster.ClusterConfig" />
		<property name="syncer" ref="org.olat.commons.coordinate.cluster.ClusterSyncer" />
		<property name="eventBus" ref="org.olat.commons.coordinate.cluster.jms.ClusterEventBus" />
		<property name="cacher" ref="infinispanCacher"/>
</bean>

<bean id="org.olat.core.util.coordinate.SingleVMCoordinator" class="org.olat.commons.coordinate.singlevm.SingleVMCoordinator" lazy-init="true">
	<property name="syncer" ref="org.olat.commons.coordinate.cluster.ClusterSyncer"/>
  <property name="eventBus" ref="org.olat.commons.coordinate.singlevm.SingleVMEventBus"/>
	<property name="locker" ref="org.olat.commons.coordinate.singlevm.SingleVMLocker"/>
	<property name="cacher" ref="infinispanCacher"/>
</bean>

<bean id="infinispanCacheManager" class="org.olat.core.util.cache.infinispan.InfinispanCacheManager" destroy-method="stop">
	<property name="configuration" value="infinispan-config.xml"/>
	<property name="jndiName" value="${infinispan.jndi}"/>
</bean>

<bean id="infinispanCacher" class="org.olat.core.util.cache.infinispan.InfinispanCacher">
	<constructor-arg index="0" ref="infinispanCacheManager"/>
	<property name="cacheConfig">
		<map>
			<entry key="LoginModule" value-ref="org.olat.login.LoginModule_blockafterfailedattempts" />
			<entry key="QTIHelper"  value-ref="org.olat.ims.qti.process.QTIHelper_QTI_xml_Documents"/>
			<entry key="WikiManager" value-ref="org.olat.modules.wiki.WikiManager_wiki"/>
			<entry key="CalendarManager" value-ref="org.olat.commons.calendar.ICalFileCalendarManager_calendar" />
			<entry key="CourseFactory" value-ref="org.olat.course.CourseFactory_courses" />
			<entry key="CollaborationToolsFactory" value-ref="org.olat.collaboration.CollaborationToolsFactory_tools" />
			<entry key="AssessmentManager" value-ref="org.olat.course.assessment.NewCachePersistingAssessmentManager" />
			<entry key="GlossaryItemManager" value-ref="org.olat.core.modules.glossary.GlossaryItemManager_glossary"/>
			<entry key="ProjectBrokerManager" value-ref="org.olat.course.nodes.projectbroker.service.ProjectBrokerManagerImpl_pb"/>
			<entry key="WebDAVManager" value-ref="org.olat.commons.servlets.WebDAVManagerImpl_webdav" />
		</map>
	</property>
</bean>
	
	
<!-- cache beans -->
<!-- MapperService, UserSessionManager, OpenMeetingsManager, FeedManager -->
<bean id="org.olat.login.LoginModule_blockafterfailedattempts" class="org.olat.core.util.cache.CacheConfig" >
	<property name="timeToLive" value="300" />
	<property name="timeToIdle" value="0" />
	<property name="maxElementsInMemory" value="1000" />
</bean>
<bean id="org.olat.ims.qti.process.QTIHelper_QTI_xml_Documents" class="org.olat.core.util.cache.CacheConfig">
	<property name="timeToLive" value="3600" />
	<property name="timeToIdle" value="1800" />
	<!-- qti files may be large -->
	<property name="maxElementsInMemory" value="20" />
</bean>					
<bean id="org.olat.modules.wiki.WikiManager_wiki" class="org.olat.core.util.cache.CacheConfig">
	<property name="timeToLive" value="14400" />
	<property name="timeToIdle" value="1800" />
	<property name="maxElementsInMemory" value="50" />								
</bean>
<bean id="org.olat.commons.calendar.ICalFileCalendarManager_calendar" class="org.olat.core.util.cache.CacheConfig">
	<property name="timeToLive" value="3600" />
	<property name="timeToIdle" value="3600" />
	<property name="maxElementsInMemory" value="50" />								
</bean>
<bean id="org.olat.course.CourseFactory_courses" class="org.olat.core.util.cache.CacheConfig">
	<property name="timeToLive" value="0" />
	<property name="timeToIdle" value="3600" />
	<property name="maxElementsInMemory" value="${course.cache.elements}" />								
</bean>
<bean id="org.olat.collaboration.CollaborationToolsFactory_tools" class="org.olat.core.util.cache.CacheConfig">
		<property name="timeToLive" value="3600" />
		<property name="timeToIdle" value="1800" />
		<property name="maxElementsInMemory" value="5000" />								
</bean>
<bean id="org.olat.core.modules.glossary.GlossaryItemManager_glossary" class="org.olat.core.util.cache.CacheConfig">
		<property name="timeToLive" value="7200" />
		<property name="timeToIdle" value="1800" />
		<property name="maxElementsInMemory" value="50" />								
</bean>
<bean id="org.olat.course.nodes.projectbroker.service.ProjectBrokerManagerImpl_pb" class="org.olat.core.util.cache.CacheConfig">
	<property name="timeToLive" value="3600" />
	<property name="timeToIdle" value="3600" />
	<property name="maxElementsInMemory" value="50" />								
</bean>
<bean id="org.olat.commons.servlets.WebDAVManagerImpl_webdav" class="org.olat.core.util.cache.CacheConfig">
	<property name="timeToLive" value="1800" />
	<property name="timeToIdle" value="300" />
	<property name="maxElementsInMemory" value="200" />								
</bean>
<bean id="org.olat.course.assessment.NewCachePersistingAssessmentManager" class="org.olat.core.util.cache.CacheConfig">
	<property name="timeToLive" value="0" />
	<property name="timeToIdle" value="60" />
	<property name="maxElementsInMemory" value="20000" />							
</bean>
															
<!-- end cache beans -->
	
<bean id="org.olat.commons.coordinate.cluster.ClusterSyncer" class="org.olat.commons.coordinate.cluster.ClusterSyncer" >
		<constructor-arg index="0" ref="lockManager" />
		<!-- if the ClusterSyncer is on debug level and if a sync takes longer than the given threshhold in miliseconds, then a warn message is written into the log -->
		<property name="executionTimeThreshold" value="1000" />
		<property name="dbInstance" ref="database"></property>
</bean>

<bean id="org.olat.commons.coordinate.cluster.jms.ClusterEventBus" class="org.olat.commons.coordinate.cluster.jms.ClusterEventBus" 
init-method="springInit" destroy-method="stop" lazy-init="true">
		<property name="clusterConfig"     ref="org.olat.commons.coordinate.cluster.ClusterConfig" />
		<property name="connectionFactory" ref="jmsConnectionFactory"/>
		<property name="destination"       ref="sysbus.topic"/>
		<property name="sendInterval"      value="15000" />
		<property name="jmsMsgDelayLimit"  value="5000" />
</bean>

<bean id="clusterLockManager" class="org.olat.commons.coordinate.cluster.lock.ClusterLockManager"/>

<bean id="org.olat.commons.coordinate.singlevm.SingleVMEventBus" class="org.olat.commons.coordinate.singlevm.SingleVMEventBus" lazy-init="true"/>

	<bean id="org.olat.commons.coordinate.singlevm.SingleVMLocker" class="org.olat.commons.coordinate.singlevm.SingleVMLocker" init-method="init" lazy-init="true">
		<property name="eventBus" ref="org.olat.commons.coordinate.singlevm.SingleVMEventBus"/>
		<lookup-method name="getPersistentLockManager" bean="persistentLockManager"/>
	</bean>

	<import resource="classpath:/serviceconfig/org/olat/core/_spring/olatcorejms_${jms.provider}.xml"/>
	
	
<!-- JMX -->
<bean id="org.springframework.jmx.support.MBeanServerFactoryBean" class="org.springframework.jmx.support.MBeanServerFactoryBean">
	<property name="locateExistingServerIfPossible" value="true" />
</bean>
<bean id="registry" class="org.springframework.remoting.rmi.RmiRegistryFactoryBean" lazy-init="true">
  <property name="port" value="${jmx.rmi.port}"/>
</bean>	

<!--  DISABLE JMX CONNECTOR	
    <bean id="serverConnector"
	      class="org.springframework.jmx.support.ConnectorServerFactoryBean" depends-on="registry">
		<property name="objectName" value="connector:name=rmi"/>
		<property name="serviceUrl" 
	            value="service:jmx:rmi://localhost/jndi/rmi://localhost:${jmx.rmi.port}/olat_connector"/>
	    <property name="daemon" value="true"/>
		<property name="environment">
-->
			 <!-- the following is only valid when the sun jmx implementation is used --> 
<!--  DISABLE JMX CONNECTOR	
   			<map>
  				<entry key="jmx.remote.x.password.file" value="/usr/local/opt/java/jre/lib/management/jmxremote.password"/>
				<entry key="jmx.remote.x.access.file" value="/usr/local/opt/java/jre/lib/management/jmxremote.access"/>
			</map>
		</property>
	</bean>
-->



</beans>	